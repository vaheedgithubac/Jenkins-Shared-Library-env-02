@Library('Jenkins-Shared-Library-env-02') _

pipeline {
    agent any

    options { 
        skipDefaultCheckout true 
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
        timestamps() 
        ansiColor('xterm')                                  // plugin: "AnsiColor"
    }

    environment {
                      // ## Project Variables ##
     PROJECT_NAME              = "myapp"                    // Must be set according
     PROJECT_KEY               = "myapp"                    // Must be set according
     COMPONENT                 = "backend"                  // Must be set according
        
                      // ## Git Variables ## 
     MY_GIT_URL                = "https://github.com/vaheedgithubac/DevOps-Project-Two-Tier-Flask-App.git"
     MY_GIT_REPO_TYPE          = "public"                   // public or private
     MY_GIT_CREDENTIALS_ID     = ""                         // Must be set for private repos
     MY_GIT_BRANCH             = ""                         // Defaults to "main" if not set
     MY_GIT_LATEST_COMMIT_ID   = get_latest_short_commit()  // <-- calls call() from shared library
                              
                      // ## Trivy FS Variables ##  
     MODE                      = "fs"                       // fs --- file system 
     TARGET                    = "."                        // Defaults to "." current directory
     OUTPUT_REPORT_FORMAT      = "table"                    // table/json/sarif/yaml

                      // ## Trivy IMAGE Variables ##  
     MODE                      = "image"                    // image scan
     TARGET                    = ""                         // Must be set in stage
     OUTPUT_REPORT_FORMAT      = "table"                    // table/json/sarif/yaml
     
    }

    stages {
        stage ("PRINT LATEST COMMIT ID") { steps { script { echo "Latest Commit ID: ${env.MY_GIT_LATEST_COMMIT_ID}" } } } 

        stage ("GIT CHECKOUT") { steps { script { git_checkout() } } }

        stage ("TRIVY - FILE SYSTEM SCAN") { steps { script { trivy_scan() } } }

        stage ("TRIVY - IMAGE SCAN") {
            steps {
                script {
                    env.TARGET = ""   // image name with Tag should be set here 
                    trivy_scan()
                }
            }
        }
    }
}
